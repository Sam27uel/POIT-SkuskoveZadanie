<!DOCTYPE html>
<html>
<head>
  <title>Brána - Ovládanie</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    nav {
      margin-bottom: 10px;
    }
    nav a {
      margin-right: 10px;
      font-weight: bold;
      text-decoration: none;
    }
    #semafor {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: gray;
      border: 2px solid #000;
      margin-top: 10px;
    }
    .btn {
      padding: 10px 20px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      color: white;
    }
    .green { background-color: green; }
    .red { background-color: red; }
    #statusBox, #monitorBox {
      margin: 10px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav>
    <a href="/">Ovládanie</a> |
    <a href="/graph">Graf</a> |
    <a href="/gauge">Ciferník</a> |
    <a href="/database">Záznamy z databázy</a>
  </nav>
  <hr>

  <h1>Riadenie brány pomocou senzora</h1>

  <button id="toggleSerial" class="btn green" onclick="toggleSerial()">Open</button><br><br>
  <div id="statusBox" style="color:red;">❌ Systém nie je inicializovaný</div>

  <label>Threshold (cm): <span id="thresholdValue">10</span></label><br>
  <input type="range" min="1" max="50" value="10" id="thresholdSlider"
         onchange="updateThreshold(this.value)"><br><br>

  <button id="toggleMonitoring" class="btn green" onclick="toggleMonitoring()" disabled>Start</button><br><br>
  <div id="monitorBox"></div>

  <h3>Záznam do databázy:</h3>
  <button id="toggleDbLogging" class="btn green">Start logging</button><br><br>

  <h3>Stav brány:</h3>
  <div id="semafor"></div><br>

  <h3>Údaje zo senzora:</h3>
  <ul id="dataList"></ul>

  <script>
    const socket = io();
    let serialOpened = false;
    let monitoringRunning = false;
    let dbLogging = false;
    let lastStatus = "unknown";

    function setStatusText(text, color = "black") {
      const box = document.getElementById("statusBox");
      box.innerText = text;
      box.style.color = color;
    }

    function setMonitorText(text, color = "gray") {
      const box = document.getElementById("monitorBox");
      box.innerText = text;
      box.style.color = color;
    }

    function toggleSerial() {
      if (!serialOpened) {
        fetch('/open', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              serialOpened = true;
              document.getElementById("toggleSerial").innerText = "Close";
              document.getElementById("toggleSerial").classList.remove("green");
              document.getElementById("toggleSerial").classList.add("red");
              document.getElementById("toggleMonitoring").disabled = false;
              setStatusText("✅ Inicializácia úspešná", "green");
            } else {
              alert("Zlyhanie spojenia");
              setStatusText("❌ Nepodarilo sa inicializovať", "red");
            }
          });
      } else {
        fetch('/close', { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            serialOpened = false;
            monitoringRunning = false;
            document.getElementById("toggleSerial").innerText = "Open";
            document.getElementById("toggleSerial").classList.remove("red");
            document.getElementById("toggleSerial").classList.add("green");

            document.getElementById("toggleMonitoring").innerText = "Start";
            document.getElementById("toggleMonitoring").classList.remove("red");
            document.getElementById("toggleMonitoring").classList.add("green");
            document.getElementById("toggleMonitoring").disabled = true;

            setStatusText("❌ Systém nie je inicializovaný", "red");
            setMonitorText("");
          });
      }
    }

    function toggleMonitoring() {
      if (!monitoringRunning) {
        fetch('/start', { method: 'POST' }).then(() => {
          monitoringRunning = true;
          document.getElementById("toggleMonitoring").innerText = "Stop";
          document.getElementById("toggleMonitoring").classList.remove("green");
          document.getElementById("toggleMonitoring").classList.add("red");
          setMonitorText("▶️ Monitorovanie spustené", "blue");
        });
      } else {
        fetch('/stop', { method: 'POST' }).then(() => {
          monitoringRunning = false;
          document.getElementById("toggleMonitoring").innerText = "Start";
          document.getElementById("toggleMonitoring").classList.remove("red");
          document.getElementById("toggleMonitoring").classList.add("green");
          setMonitorText("⏹️ Monitorovanie zastavené", "darkred");
        });
      }
    }

    function toggleDbLogging() {
      fetch('/toggle_db_logging', {
        method: 'POST'
      })
      .then(res => res.json())
      .then(data => {
        dbLogging = data.recording;
        const btn = document.getElementById("toggleDbLogging");
        if (dbLogging) {
          btn.innerText = "Stop logging";
          btn.classList.remove("green");
          btn.classList.add("red");
        } else {
          btn.innerText = "Start logging";
          btn.classList.remove("red");
          btn.classList.add("green");
        }
      });
    }

    function updateThreshold(val) {
      document.getElementById("thresholdValue").innerText = val;
      fetch('/set_threshold', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `threshold=${val}`
      });
    }

    socket.on('connect', () => {
      setInterval(() => {
        socket.emit('request_data');
      }, 1000);
    });

    socket.on('serial_data', data => {
      const list = document.getElementById('dataList');
      const semafor = document.getElementById('semafor');
      list.innerHTML = '';

      let status = null;

      (data.data || []).forEach(line => {
        const li = document.createElement('li');
        li.innerText = line;
        list.appendChild(li);

        if (line.includes("otvorená")) status = "open";
        else if (line.includes("zatvorená")) status = "closed";
      });

      if (status !== null) lastStatus = status;

      if (lastStatus === "open") semafor.style.backgroundColor = "green";
      else if (lastStatus === "closed") semafor.style.backgroundColor = "red";
      else semafor.style.backgroundColor = "gray";
    });

    // ✅ Pridanie event handlera po načítaní DOM
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("toggleDbLogging").addEventListener("click", toggleDbLogging);
    });
  </script>
</body>
</html>
